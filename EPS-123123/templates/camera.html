{% extends "base.html" %}
{% load static %}

{% block content %}

    <div class="relative w-full h-screen bg-gray-100">
        <div id="canvas-container" class="w-full h-full block"></div>

        <div class="absolute top-4 left-4 p-4 bg-white/90 rounded-lg shadow-lg backdrop-blur-sm z-10">
            <h1 class="text-xl font-bold text-gray-800">Control de Personaje</h1>
            <p class="text-sm text-gray-600 mb-2">Estado: <span id="status-text" class="font-bold text-blue-600">Esperando</span>
            </p>

            <div class="flex gap-2 items-end">
                <div>
                    <label class="text-xs text-gray-500 block">Posición X</label>
                    <input type="number" id="inputX" value="0" class="w-16 p-1 border rounded text-sm text-gray-700">
                </div>
                <div>
                    <label class="text-xs text-gray-500 block">Posición Z</label>
                    <input type="number" id="inputZ" value="0" class="w-16 p-1 border rounded text-sm text-gray-700">
                </div>
                <button id="btn-move"
                        class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded transition">
                    ¡Andar!
                </button>
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
        import {OrbitControls} from 'three/addons/controls/OrbitControls.js';

        function init() {
            // --- VARIABLES GLOBALES ---
            let characterMesh;
            let mixer;
            let actions = {};
            let activeAction;

            // Variables de movimiento
            let targetPosition = null;
            const moveSpeed = 2.0;
            let isMoving = false;

            const clock = new THREE.Clock();
            const container = document.getElementById('canvas-container');
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf3f4f6);

            // --- CÁMARA ---
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 10, 15);

            const renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            container.appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // --- LUCES ---
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 2);
            hemiLight.position.set(0, 20, 0);
            scene.add(hemiLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // --- SUELO ---
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);
            const gridHelper = new THREE.GridHelper(20, 20);
            scene.add(gridHelper);

            const loader = new GLTFLoader();

            // 1. CARGAR IGLESIA
            const mainModelPath = "{% static 'models/room/scene.glb' %}";
            loader.load(mainModelPath, function (gltf) {
                const model = gltf.scene;
                model.rotation.x = -Math.PI / 2;
                model.traverse((node) => {
                    if (node.isMesh) node.receiveShadow = true;
                });
                scene.add(model);
            });

            // 2. CARGAR PERSONAJE
            const characterPath = "{% static 'models/caracter/personaje.glb' %}";
            const walkAnimPath = "{% static 'models/caracter/Walking.glb' %}";

            loader.load(characterPath, function (charGltf) {
                characterMesh = charGltf.scene;
                characterMesh.position.set(0, 0, 0);
                characterMesh.scale.set(3, 3, 3);
                characterMesh.traverse((node) => {
                    if (node.isMesh) {
                        node.castShadow = true;
                        node.receiveShadow = true;
                    }
                });
                scene.add(characterMesh);

                mixer = new THREE.AnimationMixer(characterMesh);

                // Cargar Idle SI existe
                if (charGltf.animations.length > 0) {
                    const idleClip = charGltf.animations[0];
                    actions['Idle'] = mixer.clipAction(idleClip);
                    actions['Idle'].play();
                    activeAction = actions['Idle'];
                }

                // Cargar Walk
                loader.load(walkAnimPath, function (animGltf) {
                    if (animGltf.animations.length > 0) {
                        const walkClip = animGltf.animations[0];
                        actions['Walk'] = mixer.clipAction(walkClip);
                        console.log("Walk animation loaded");
                    }
                });
            });

            // 3. EVENTO BOTÓN
            document.getElementById('btn-move').addEventListener('click', () => {
                if (!characterMesh || !actions['Walk']) return;

                const x = parseFloat(document.getElementById('inputX').value) || 0;
                const z = parseFloat(document.getElementById('inputZ').value) || 0;

                targetPosition = new THREE.Vector3(x, 0, z);
                isMoving = true;

                // Transición a Caminar
                if (activeAction !== actions['Walk']) {
                    if (activeAction) activeAction.fadeOut(0.5);
                    actions['Walk'].reset().fadeIn(0.5).play();
                    activeAction = actions['Walk'];
                    document.getElementById('status-text').innerText = "Caminando...";
                }
            });

            window.addEventListener('resize', onWindowResize);

            function onWindowResize() {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            }

            // =========================================================
            // 4. ANIMATE (LÓGICA CORREGIDA AQUÍ)
            // =========================================================
            function animate() {
                requestAnimationFrame(animate);

                const delta = clock.getDelta();

                if (characterMesh && isMoving && targetPosition) {
                    const currentPos = characterMesh.position.clone();
                    const distance = currentPos.distanceTo(targetPosition);

                    if (distance > 0.1) {
                        // Moverse
                        const direction = new THREE.Vector3().subVectors(targetPosition, currentPos).normalize();
                        characterMesh.position.addScaledVector(direction, moveSpeed * delta);
                        characterMesh.lookAt(targetPosition);
                    } else {
                        // --- LLEGADA AL DESTINO ---
                        isMoving = false;
                        characterMesh.position.copy(targetPosition); // Fijar posición exacta

                        // CORRECCIÓN: Detener 'Walk' siempre
                        if (actions['Walk']) {
                            actions['Walk'].fadeOut(0.5);
                        }

                        // CORRECCIÓN: Activar 'Idle' SOLO si existe, si no, null
                        if (actions['Idle']) {
                            actions['Idle'].reset().fadeIn(0.5).play();
                            activeAction = actions['Idle'];
                        } else {
                            // Si no hay idle, simplemente dejamos que el Walk se desvanezca
                            activeAction = null;
                        }

                        document.getElementById('status-text').innerText = "Llegado";
                    }
                }

                if (mixer) mixer.update(delta);
                controls.update();
                renderer.render(scene, camera);
            }

            animate();
        }

        init();
    </script>
{% endblock content %}