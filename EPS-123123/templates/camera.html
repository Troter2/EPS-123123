{% extends "base.html" %}
{% load static %}

{% block content %}

    <div class="relative w-full h-screen bg-gray-100">
        <div id="canvas-container" class="w-full h-full block"></div>

        <div class="absolute top-4 left-4 p-4 bg-white/90 rounded-lg shadow-lg backdrop-blur-sm z-10 w-80">
            <h1 class="text-xl font-bold text-gray-800">Control de Personaje</h1>

            <div class="flex justify-between items-center mb-4">
                <p class="text-sm text-gray-600">Estado: <span id="status-text" class="font-bold text-blue-600">Manual</span></p>

                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="toggle-ai" class="sr-only peer">
                    <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    <span class="ms-3 text-sm font-medium text-gray-900">Cámara AI</span>
                </label>
            </div>

            <div id="camera-preview" class="hidden mb-4 border-2 border-blue-500 rounded overflow-hidden bg-black">
                <p class="text-xs text-white bg-blue-600 px-2 py-1">Vista en vivo</p>
                <img id="camera-stream" src="" class="w-full h-auto" alt="Esperando stream..."/>
            </div>

            <div id="manual-controls" class="flex gap-2 items-end transition-opacity duration-300">
                <div>
                    <label class="text-xs text-gray-500 block">Posición X</label>
                    <input type="number" id="inputX" value="0" class="w-16 p-1 border rounded text-sm text-gray-700">
                </div>
                <div>
                    <label class="text-xs text-gray-500 block">Posición Z</label>
                    <input type="number" id="inputZ" value="0" class="w-16 p-1 border rounded text-sm text-gray-700">
                </div>
                <button id="btn-move"
                        class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-bold py-1 px-3 rounded transition">
                    Ir
                </button>
            </div>

            <div class="mt-2 pt-2 border-t border-gray-200" id="limbs-container">
                <p class="text-xs font-bold text-gray-500 mb-1">Datos Tracking:</p>
                <div class="grid grid-cols-2 gap-x-2 gap-y-1 text-[10px] font-mono text-gray-700">
                    <div>M.Izq: <span id="l-wrist-val" class="text-blue-600">--</span></div>
                    <div>M.Der: <span id="r-wrist-val" class="text-blue-600">--</span></div>
                    <div>T.Izq: <span id="l-ankle-val" class="text-orange-600">--</span></div>
                    <div>T.Der: <span id="r-ankle-val" class="text-orange-600">--</span></div>
                    <div>Cadera: <span id="hip-val" class="text-purple-600">--</span></div>
                    <div>Nariz: <span id="nose-val" class="text-purple-600">--</span></div>
                </div>
            </div>

            <div class="mt-2 text-xs text-gray-400 font-mono" id="debug-coords">
                Esperando activación...
            </div>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import {GLTFLoader} from 'three/addons/loaders/GLTFLoader.js';
        import {OrbitControls} from 'three/addons/controls/OrbitControls.js';

        function init() {
            // --- VARIABLES ---
            let characterMesh;
            let mixer;
            let actions = {};
            let activeAction;

            let targetPosition = new THREE.Vector3(0, 0, 0);
            let isMoving = false;

           // Configuración
            let aiEnabled = false;
            const mapSize = 20;

            // URLs
            // URL del stream de video (si usas un servidor de video separado)
            const videoStreamUrl = "http://localhost:8080/video_feed";

            // CORRECCIÓN: Apuntar a la vista Django definida en urls.py
            const apiDataUrl = "/api/get-pose/";

            const clock = new THREE.Clock();
            const container = document.getElementById('canvas-container');

            // ESCENA
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0xf3f4f6);

            // CÁMARA 3D
            const camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            camera.position.set(0, 12, 15);

            const renderer = new THREE.WebGLRenderer({antialias: true});
            renderer.setSize(container.clientWidth, container.clientHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.outputColorSpace = THREE.SRGBColorSpace;
            container.appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;

            // LUCES
            const hemiLight = new THREE.HemisphereLight(0xffffff, 0x444444, 2);
            hemiLight.position.set(0, 20, 0);
            scene.add(hemiLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(5, 10, 7);
            dirLight.castShadow = true;
            scene.add(dirLight);

            // SUELO
            const axesHelper = new THREE.AxesHelper(5);
            scene.add(axesHelper);
            const gridHelper = new THREE.GridHelper(mapSize, mapSize);
            scene.add(gridHelper);

            const loader = new GLTFLoader();

            // CARGAR MODELOS
            loader.load("{% static 'models/room/scene.glb' %}", function (gltf) {
                const model = gltf.scene;
                model.rotation.x = -Math.PI / 2;
                model.traverse((node) => {
                    if (node.isMesh) node.receiveShadow = true;
                });
                scene.add(model);
            });

            loader.load("{% static 'models/caracter/personaje.glb' %}", function (charGltf) {
                characterMesh = charGltf.scene;
                characterMesh.position.set(0, 0, 0);
                characterMesh.scale.set(3, 3, 3);
                characterMesh.traverse((node) => {
                    if (node.isMesh) {
                        node.castShadow = true;
                        node.receiveShadow = true;
                    }
                });
                scene.add(characterMesh);

                mixer = new THREE.AnimationMixer(characterMesh);
                if (charGltf.animations.length > 0) {
                    actions['Idle'] = mixer.clipAction(charGltf.animations[0]);
                    actions['Idle'].play();
                    activeAction = actions['Idle'];
                }

                loader.load("{% static 'models/caracter/Walking.glb' %}", function (animGltf) {
                    if (animGltf.animations.length > 0) {
                        actions['Walk'] = mixer.clipAction(animGltf.animations[0]);
                    }
                });
            });

            // --- LÓGICA UI ---
            const toggleAi = document.getElementById('toggle-ai');
            const manualDiv = document.getElementById('manual-controls');
            const statusText = document.getElementById('status-text');
            const cameraPreview = document.getElementById('camera-preview');
            const cameraImg = document.getElementById('camera-stream');

            toggleAi.addEventListener('change', (e) => {
                aiEnabled = e.target.checked;

                if (aiEnabled) {
                    manualDiv.style.opacity = '0.5';
                    manualDiv.style.pointerEvents = 'none';
                    statusText.innerText = "Conectando Video...";
                    cameraPreview.classList.remove('hidden');
                    cameraImg.src = videoStreamUrl;
                } else {
                    manualDiv.style.opacity = '1';
                    manualDiv.style.pointerEvents = 'auto';
                    statusText.innerText = "Manual";
                    isMoving = false;
                    cameraPreview.classList.add('hidden');
                    cameraImg.src = "";
                    stopWalking();
                }
            });

            document.getElementById('btn-move').addEventListener('click', () => {
                if (!characterMesh || !actions['Walk'] || aiEnabled) return;
                const x = parseFloat(document.getElementById('inputX').value) || 0;
                const z = parseFloat(document.getElementById('inputZ').value) || 0;
                setTargetPosition(x, z);
            });

            // --- MODIFICADO: FUNCIÓN PARA PROCESAR EXTREMIDADES ---
            function processExtremities(limbs) {
                if (!limbs) return;

                const setText = (id, val) => {
                    const el = document.getElementById(id);
                    if(el) el.innerText = val;
                };

                // Manos
                if (limbs.left_wrist) setText('l-wrist-val', `y:${limbs.left_wrist.y.toFixed(2)}`);
                if (limbs.right_wrist) setText('r-wrist-val', `y:${limbs.right_wrist.y.toFixed(2)}`);

                // Pies (Tobillos)
                if (limbs.left_ankle) setText('l-ankle-val', `y:${limbs.left_ankle.y.toFixed(2)}`);
                if (limbs.right_ankle) setText('r-ankle-val', `y:${limbs.right_ankle.y.toFixed(2)}`);

                // Caderas (Usamos promedio o una sola para debug)
                if (limbs.left_hip) setText('hip-val', `x:${limbs.left_hip.x.toFixed(2)}`);

                // Nariz
                if (limbs.nose) setText('nose-val', `y:${limbs.nose.y.toFixed(2)}`);
            }

            // --- MODIFICADO: API POLLING HACIA FASTAPI ---
            async function fetchFromAPI() {
                if (!aiEnabled) return;

                try {
                    const response = await fetch(apiDataUrl);
                    if (!response.ok) throw new Error("API Offline");

                    const data = await response.json();

                    let mainX = 0.5;
                    let mainY = 0.5;
                    let hasData = false;

                    // Si Python envía estructura "extremities"
                    if (data.extremities && data.extremities.nose) {
                        mainX = data.extremities.nose.x; // Ahora esto es 0.0 - 1.0
                        mainY = data.extremities.nose.y; // Ahora esto es 0.0 - 1.0
                        hasData = true;

                        // Actualizar UI
                        processExtremities(data.extremities);
                    }

                    if (hasData) {
                        // Math para convertir 0-1 a coordenadas de mundo (-10 a 10 aprox)
                        // Invertimos X para que funcione como espejo
                        const worldX = -(mainX - 0.5) * mapSize;
                        const worldZ = (mainY - 0.5) * mapSize;

                        setTargetPosition(worldX, worldZ);

                        statusText.innerText = "AI Recibiendo Datos";
                        statusText.classList.replace("text-blue-600", "text-green-600");
                    }

                } catch (error) {
                    // console.log(error);
                    statusText.innerText = "Esperando Tracker...";
                    statusText.classList.replace("text-green-600", "text-blue-600");
                }
            }

            setInterval(fetchFromAPI, 100); // 10 FPS de actualización de datos

            function setTargetPosition(x, z) {
                targetPosition.set(x, 0, z);
                isMoving = true;

                if (actions['Walk'] && activeAction !== actions['Walk']) {
                    if (activeAction) activeAction.fadeOut(0.2);
                    actions['Walk'].reset().fadeIn(0.2).play();
                    activeAction = actions['Walk'];
                }
            }

            // --- BUCLE DE ANIMACIÓN ---
            function animate() {
                requestAnimationFrame(animate);
                const delta = clock.getDelta();

                if (characterMesh && isMoving) {
                    const alpha = 0.1;
                    characterMesh.position.lerp(targetPosition, alpha);

                    const distance = characterMesh.position.distanceTo(targetPosition);

                    if (distance > 0.1) {
                        characterMesh.lookAt(targetPosition.x, characterMesh.position.y, targetPosition.z);
                    } else {
                        if (!aiEnabled) {
                            isMoving = false;
                            stopWalking();
                        } else {
                            if (distance < 0.05) stopWalking();
                        }
                    }
                }

                if (mixer) mixer.update(delta);
                controls.update();
                renderer.render(scene, camera);
            }

            function stopWalking() {
                if (actions['Idle'] && activeAction !== actions['Idle']) {
                    if (activeAction) activeAction.fadeOut(0.2);
                    actions['Idle'].reset().fadeIn(0.2).play();
                    activeAction = actions['Idle'];
                }
            }

            window.addEventListener('resize', () => {
                camera.aspect = container.clientWidth / container.clientHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(container.clientWidth, container.clientHeight);
            });

            animate();
        }

        init();
    </script>
{% endblock content %}